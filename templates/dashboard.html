<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="dashboard_title">GlobalAsianElite - é¦–é¡µ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="/static/js/translations.js"></script>
    <style>
        :root {
            --primary-purple: #5e3a6e;
        }
        body {
            min-height: 100vh;
            background: radial-gradient(circle at 0% 0%, #ffe6f0 0, #f0f2f5 40%, #e6f0ff 100%);
            position: relative;
            overflow-x: hidden;
        }
        body::before {
            content: "";
            position: fixed;
            inset: 0;
            pointer-events: none;
            background-image:
                radial-gradient(circle at 15% 20%, rgba(255,192,203,0.55) 0, transparent 55%),
                radial-gradient(circle at 80% 75%, rgba(186,85,211,0.45) 0, transparent 55%),
                radial-gradient(circle at 40% 90%, rgba(255,182,193,0.35) 0, transparent 60%);
            opacity: 0.9;
            animation: romanticFloat 28s linear infinite alternate;
            z-index: -1;
        }
        @keyframes romanticFloat {
            0% { transform: translate3d(0, 0, 0); }
            100% { transform: translate3d(0, -24px, 0); }
        }
        .navbar {
            background-color: var(--primary-purple);
        }
        .navbar-brand, .nav-link {
            color: white !important;
        }
        .modal-header {
            border-bottom: none;
            text-align: center;
            display: block;
        }
        .modal-footer {
            border-top: none;
            justify-content: center;
        }
        .heart-icon {
            font-size: 4rem;
            color: #ccc;
            margin-bottom: 20px;
        }
        .notify-container {
            position: fixed;
            right: 16px;
            bottom: 24px;
            z-index: 1050;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .notify-item {
            background: rgba(0,0,0,0.85);
            color: #fff;
            border-radius: 12px;
            padding: 12px 14px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.25);
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 360px;
        }
        .notify-avatar {
            width: 36px; height: 36px; border-radius: 50%; object-fit: cover; background:#666; display:flex; align-items:center; justify-content:center;
        }
        .notify-title { font-weight: 600; }
        .notify-actions { margin-left: auto; display:flex; gap:8px; }
        .notify-actions form { display:inline; }
        .member-card {
            border-radius: 14px;
            overflow: hidden;
            background: rgba(255,255,255,0.96);
        }
        .member-card-inner {
            display: flex;
            height: 100%;
        }
        .member-photo {
            width: 42%;
            min-height: 220px;
            background-color: #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .member-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .member-info {
            width: 58%;
            padding: 10px 12px 8px;
            display: flex;
            flex-direction: column;
            font-size: 0.9rem;
        }
        .member-name-line {
            font-weight: 600;
            font-size: 1rem;
        }
        .member-meta {
            font-size: 0.8rem;
        }
        .member-actions button.btn-link {
            padding: 0;
            border: 0;
        }
        .member-actions .icon-btn {
            font-size: 1.1rem;
        }
    </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg mb-4">
    <div class="container">
        <a class="navbar-brand" href="#">GlobalAsianElite</a>
        <div class="collapse navbar-collapse">
            <ul class="navbar-nav me-auto">
                <li class="nav-item"><a class="nav-link active" href="/dashboard" data-i18n="nav_home">é¦–é¡µ</a></li>
                <li class="nav-item position-relative">
                    <a class="nav-link" href="/messages"><span data-i18n="nav_messages">è®¯æ¯</span></a>
                    {% if unread_messages_count is defined and unread_messages_count > 0 %}
                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                        {{ unread_messages_count if unread_messages_count <= 99 else '99+' }}
                    </span>
                    {% endif %}
                </li>
                <li class="nav-item"><a class="nav-link" href="/activity"><span data-i18n="nav_activity">æ´»åŠ¨çºªå½•</span> <span class="badge bg-secondary rounded-pill">{{ activity_counts['likes'] + activity_counts['favorites'] + activity_counts['views'] + activity_counts['blocks'] }}</span></a></li>
            </ul>
            <span class="navbar-text text-white">
                <span data-i18n="welcome_msg">æ¬¢è¿</span>, {{ user.name or 'ä¼šå‘˜' }}
            </span>
            <a href="/logout" class="btn btn-outline-light btn-sm ms-3" data-i18n="logout_btn">é€€å‡º</a>
        </div>
    </div>
</nav>

{% if notifications and notifications|length > 0 %}
<div class="notify-container">
    {% for n in notifications %}
    <div class="notify-item">
        {% if n['actor_avatar'] %}
        <img src="{{ n['actor_avatar'] }}" class="notify-avatar" alt="å¤´åƒ">
        {% else %}
        <div class="notify-avatar">ğŸ‘¤</div>
        {% endif %}
        <div>
            <div class="notify-title">
                {% if n['type'] == 'view' %}
                <span data-i18n="notify_view_profile">æœ‰äººæŸ¥çœ‹äº†æ‚¨çš„ä¸ªäººèµ„æ–™ï¼</span>
                {% elif n['type'] == 'like' %}
                <span data-i18n="notify_like_profile">ä½ åˆæ”¶åˆ°äº†ä¸€ä¸ªèµï¼</span>
                {% else %}
                <span data-i18n="notify_new">æ–°é€šçŸ¥</span>
                {% endif %}
            </div>
            <div class="small text-white-50">
                <a href="/member/{{ n['actor_id'] }}" class="link-light text-decoration-none" data-i18n="notify_view_interaction">
                    æŸ¥çœ‹è°ä¸æ‚¨äº’åŠ¨
                </a>
            </div>
        </div>
        <div class="notify-actions">
            <form action="/notifications/{{ n['id'] }}/read" method="post">
                <button class="btn btn-sm btn-outline-light" type="submit" data-i18n="notify_close_btn">å…³é—­</button>
            </form>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Right Side Quick Menu -->
<div id="quickMenu" class="position-fixed" style="right:16px; top:14px; z-index:1070;">
    <div class="dropdown">
        <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" style="background-color: var(--primary-purple); color: #fff; border-color: #fff;" data-i18n="quick_menu_btn">
            åŠŸèƒ½
        </button>
        <ul class="dropdown-menu dropdown-menu-end shadow">
            <li><a class="dropdown-item" href="/member/{{ user.id }}" data-i18n="quick_view_profile">æµè§ˆæ–‡æ¡£</a></li>
            <li><a class="dropdown-item" href="/profile/edit" data-i18n="quick_edit_profile">æ–‡æ¡£ç¼–è¾‘</a></li>
            <li><a class="dropdown-item" href="/profile/photos" data-i18n="quick_photos">ç…§ç‰‡</a></li>
            <li><a class="dropdown-item" href="/dashboard" data-i18n="quick_match">ä½³ç¼˜</a></li>
            <li><a class="dropdown-item" href="/profile/edit#appearance" data-i18n="quick_interests">å…´è¶£å—œå¥½</a></li>
            <li><a class="dropdown-item" href="/profile/edit#basic" data-i18n="quick_personality">ä¸ªæ€§æ–‡æ¡£</a></li>
            <li><a class="dropdown-item" href="/verification" data-i18n="quick_verify">éªŒè¯æ–‡æ¡£èµ„æ–™</a></li>
            <li><a class="dropdown-item" href="/safety" data-i18n="quick_imbra">IMBRA</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="#" id="enableBrowserNotify" data-i18n="quick_enable_notify">å¼€å¯æ–°æ¶ˆæ¯æµè§ˆå™¨é€šçŸ¥</a></li>
        </ul>
    </div>
</div>

<!-- Ideal Match Modal -->
<div class="modal fade" id="matchModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <div class="heart-icon">â™¥</div>
                <h4 class="modal-title" data-i18n="modal_match_title">æè¿°æ‚¨ç†æƒ³çš„å¯¹è±¡æ¥ç»§ç»­</h4>
                <p class="text-muted small" data-i18n="modal_match_subtitle">å›ç­”ä¸‹åˆ—æœ‰å…³æ‚¨ç†æƒ³å¯¹è±¡çš„æ¡ä»¶:</p>
            </div>
            <div class="modal-body">
                <form>
                    <div class="mb-3">
                        <label class="form-label" data-i18n="match_seeking">å¯»æ‰¾:</label>
                        <select class="form-select">
                            <option data-i18n="male">ç”·æ€§</option>
                            <option data-i18n="female">å¥³æ€§</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" data-i18n="match_age">å¹´é¾„:</label>
                        <div class="d-flex gap-2">
                            <select class="form-select"><option>18</option><option selected>40</option></select>
                            <span class="align-self-center" data-i18n="match_to">è‡³</span>
                            <select class="form-select"><option>50</option><option selected>65</option></select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" data-i18n="match_location">å±…ä½åœ°åŒº:</label>
                        <select class="form-select">
                            <option data-i18n="match_any_country">ä»»ä½•å›½å®¶</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" data-i18n="match_smoking">æ˜¯å¦æŠ½çƒŸ?</label>
                        <div class="d-flex gap-3">
                            <div class="form-check"><input class="form-check-input" type="checkbox" checked><label class="form-check-label" data-i18n="match_any">ä¸é™</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox"><label class="form-check-label" data-i18n="match_no_smoke">ä¸æŠ½çƒŸ</label></div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-purple w-100" data-bs-dismiss="modal" style="background-color: var(--primary-purple); color: white;" data-i18n="match_save_btn">ä¿å­˜å¹¶ç»§ç»­</button>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3">
            <div class="card mb-3">
                <div class="card-body text-center">
                    {% if user.avatar_path %}
                    <a href="/member/{{ user.id }}"><img src="{{ user.avatar_path }}" class="rounded-circle mb-3" style="width: 100px; height: 100px; object-fit: cover;"></a>
                    {% else %}
                    <a href="/member/{{ user.id }}" class="d-inline-block">
                        <div class="bg-secondary rounded-circle mb-3 mx-auto d-flex align-items-center justify-content-center" style="width: 100px; height: 100px; color: white; font-size: 2rem; cursor:pointer;">
                            {{ user.name[0] if user.name else 'ç”¨' }}
                        </div>
                    </a>
                    {% endif %}
                    <h5 class="card-title">{{ user.name or 'æœªè®¾ç½®æ˜µç§°' }}</h5>
                    <p class="card-text text-muted">{{ user.city or user.country }}</p>
                    
                    <div class="d-grid gap-2">
                        <a href="/profile/edit" class="btn btn-outline-primary btn-sm">ç¼–è¾‘èµ„æ–™</a>
                        <a href="/profile/photos" class="btn btn-outline-primary btn-sm">ä¸Šä¼ ç…§ç‰‡</a>
                        {% if not user.is_verified %}
                        <a href="/verification" class="btn btn-warning btn-sm">å®åè®¤è¯ (æœªå®Œæˆ)</a>
                        {% else %}
                        <button class="btn btn-success btn-sm" disabled>å·²å®åè®¤è¯ âœ“</button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-md-9">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4>æ¨èä¼šå‘˜</h4>
                <div class="d-flex flex-wrap gap-2">
                    <a class="btn btn-outline-secondary btn-sm {{ 'active' if filter=='' else '' }}" href="/dashboard">ä½³ç¼˜</a>
                    <a class="btn btn-outline-secondary btn-sm {{ 'active' if filter=='mutual' else '' }}" href="/dashboard?filter=mutual">åŒå‘é…å¯¹</a>
                    <a class="btn btn-outline-secondary btn-sm {{ 'active' if filter=='i_liked' else '' }}" href="/dashboard?filter=i_liked">åå‘é…å¯¹ä½³ç¼˜</a>
                    <a class="btn btn-outline-secondary btn-sm {{ 'active' if filter=='online' else '' }}" href="/dashboard?filter=online">åœ¨çº¿</a>
                    <div class="btn-group">
                        <a class="btn btn-outline-secondary btn-sm {{ 'active' if sort=='active' else '' }}" href="/dashboard?sort=active">æŒ‰æ´»è·ƒ</a>
                        <a class="btn btn-outline-secondary btn-sm {{ 'active' if sort=='verified' else '' }}" href="/dashboard?sort=verified">å·²è®¤è¯ä¼˜å…ˆ</a>
                        <a class="btn btn-outline-secondary btn-sm {{ 'active' if sort=='photos' else '' }}" href="/dashboard?sort=photos">æœ‰ç…§ç‰‡ä¼˜å…ˆ</a>
                    </div>
                    <a class="btn btn-outline-secondary btn-sm {{ 'active' if filter=='favorites' else '' }}" href="/dashboard?filter=favorites">æˆ‘çš„æœ€çˆ±</a>
                    <a class="btn btn-outline-secondary btn-sm {{ 'active' if sort=='' else '' }}" href="/dashboard?sort=">æœ€æ–°åŠ å…¥ä¼šå‘˜</a>
                    <a class="btn btn-outline-secondary btn-sm {{ 'active' if sort=='photos' else '' }}" href="/dashboard?sort=photos">æœ€æ–°ç…§ç‰‡</a>
                    <a class="btn btn-outline-secondary btn-sm {{ 'active' if filter=='my_region' else '' }}" href="/dashboard?filter=my_region">æˆ‘çš„åœ°åŒº</a>
                </div>
            </div>

            <div class="row row-cols-1 row-cols-md-3 g-4">
                {% for m in members %}
                <div class="col">
                    <div class="member-card card shadow-sm h-100" data-member-id="{{ m['id'] }}">
                        <div class="member-card-inner">
                            <a href="/member/{{ m['id'] }}" class="member-photo text-decoration-none">
                                {% if m['avatar_path'] %}
                                <img src="{{ m['avatar_path'] }}" alt="å¤´åƒ">
                                {% else %}
                                <div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:#999;font-size:2rem;">{{ (m['name'] or 'ç”¨æˆ·')[0] if m['name'] else 'ç”¨æˆ·' }}</div>
                                {% endif %}
                            </a>
                            <div class="member-info">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <div class="member-name-line">
                                            <a href="/member/{{ m['id'] }}" class="text-decoration-none text-dark">{{ m['name'] or ('ä¼šå‘˜'+m['id']|string) }}</a>
                                            {% if m['is_verified'] %}<span class="badge bg-success ms-1" style="font-size:0.7rem;" data-i18n="verified_badge">å·²å®åè®¤è¯</span>{% endif %}
                                        </div>
                                        <div class="member-meta text-muted">
                                            {{ m['age_range'] }}
                                            {% if m['country'] %} Â· {{ m['country'] }}{% endif %}
                                        </div>
                                    </div>
                                    <div class="text-end">
                                        {% if m['is_new'] %}
                                        <div><span class="badge bg-success" style="font-size:0.7rem;">æ–°ä¼šå‘˜</span></div>
                                        {% endif %}
                                        <div class="mt-1">
                                            {% if m['is_online'] %}
                                            <span class="badge rounded-pill bg-success" style="font-size:0.7rem;" data-online-badge="1">åœ¨çº¿</span>
                                            {% else %}
                                            <span class="badge rounded-pill bg-secondary" style="font-size:0.7rem;" data-online-badge="1">ç¦»çº¿</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-2 text-muted" style="font-size:0.8rem;">
                                    å¯»æ‰¾:
                                    {% if m['match_gender'] == 'male' %} ç”·æ€§{% elif m['match_gender'] == 'female' %} å¥³æ€§{% else %} ä¸é™{% endif %}
                                    {% if m['match_age_min'] and m['match_age_max'] %}
                                        ï¼Œ{{ m['match_age_min'] }}-{{ m['match_age_max'] }}
                                    {% endif %}
                                </div>
                                <div class="member-actions d-flex justify-content-between align-items-center mt-2">
                                    <div class="d-flex align-items-center gap-2">
                                        <form action="/like/{{ m['id'] }}" method="post" class="d-inline">
                                            <button class="btn btn-link icon-btn text-muted" type="submit">â¤</button>
                                        </form>
                                        <button type="button" class="btn btn-link icon-btn text-muted" data-chat="{{ m['id'] }}">ğŸ’¬</button>
                                        <form action="/block/{{ m['id'] }}" method="post" class="d-inline">
                                            <button class="btn btn-link icon-btn text-muted" type="submit">ğŸš«</button>
                                        </form>
                                        <form action="/favorite/{{ m['id'] }}" method="post" class="d-inline">
                                            <button class="btn btn-link icon-btn text-muted" type="submit">â­</button>
                                        </form>
                                    </div>
                                    <div class="d-flex align-items-center text-muted" style="font-size:0.8rem;">
                                        <a href="/member/{{ m['id'] }}" class="text-muted text-decoration-none icon-btn">ğŸ“·</a>
                                        {% if m['photos_count'] %}
                                        <span class="ms-1">{{ m['photos_count'] }}</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var myModal = new bootstrap.Modal(document.getElementById('matchModal'));
        var notifyBtn = document.getElementById('enableBrowserNotify');
        if (notifyBtn) {
            notifyBtn.addEventListener('click', function(e) {
                e.preventDefault();
                enableBrowserNotifications();
            });
        }
        initMessageNotifications();
        startPresence();
    });

    const chatPanel = document.createElement('div');
    chatPanel.id = 'chatPanel';
    chatPanel.style.position = 'fixed';
    chatPanel.style.right = '16px';
    chatPanel.style.top = '80px';
    chatPanel.style.width = '340px';
    chatPanel.style.maxHeight = '70vh';
    chatPanel.style.background = '#2f2140';
    chatPanel.style.color = '#fff';
    chatPanel.style.borderRadius = '12px';
    chatPanel.style.boxShadow = '0 10px 24px rgba(0,0,0,0.3)';
    chatPanel.style.display = 'none';
    chatPanel.style.flexDirection = 'column';
    chatPanel.style.zIndex = '1060';
    chatPanel.innerHTML = '<div id="chatHeader" style="padding:12px;display:flex;justify-content:space-between;align-items:center;"></div><div id="chatMessages" style="padding:12px;overflow:auto;flex:1;background:#fff;color:#000"></div><form id="chatForm" style="padding:12px;border-top:1px solid #ddd;background:#fff"><div class="mb-1"><button type="button" class="btn btn-sm btn-light me-1 chat-emoji">ğŸ˜Š</button><button type="button" class="btn btn-sm btn-light me-1 chat-emoji">ğŸ˜‚</button><button type="button" class="btn btn-sm btn-light me-1 chat-emoji">ğŸ˜</button><button type="button" class="btn btn-sm btn-light me-1 chat-emoji">ğŸ˜˜</button><button type="button" class="btn btn-sm btn-light me-1 chat-emoji">ğŸ˜‰</button></div><div class="input-group"><input name="content" class="form-control" placeholder="è¾“å…¥æ¶ˆæ¯..."/><button class="btn btn-primary" type="submit">å‘é€</button></div></form>';
    document.body.appendChild(chatPanel);

    let currentPeer = null;
    let chatPollTimer = null;
    const CURRENT_USER_ID = Number('{{ user.id }}');

    async function renderChatMessages(data) {
        const h = document.getElementById('chatHeader');
        const m = document.getElementById('chatMessages');
        if (!h || !m) return;
        const name = data.peer.name || 'ä¼šå‘˜';
        let subtitle = data.peer.country || '';
        if (data.peer.whatsapp_contact) {
            subtitle += subtitle ? ' â€¢ ' : '';
            subtitle += 'WhatsApp: ' + data.peer.whatsapp_contact;
        }
        h.innerHTML = '<div class="d-flex align-items-center"><div class="rounded-circle me-2" style="width:28px;height:28px;background:#666;display:flex;align-items:center;justify-content:center;color:#fff;">' + name.slice(0,1) + '</div><div><strong>' + name + '</strong><div class="small">' + subtitle + '</div></div></div><button type="button" class="btn btn-sm btn-outline-light" id="chatClose">âœ•</button>';
        m.innerHTML = '';
        data.msgs.forEach(x => {
            const mine = x.sender_id === CURRENT_USER_ID;
            const row = document.createElement('div');
            row.style.display = 'flex';
            row.style.justifyContent = mine ? 'flex-end' : 'flex-start';
            const bubble = document.createElement('div');
            bubble.style.maxWidth = '80%';
            bubble.style.padding = '8px 12px';
            bubble.style.margin = '6px 0';
            bubble.style.borderRadius = '12px';
            bubble.style.background = mine ? '#e5f0ff' : '#f3f3f3';
            bubble.textContent = x.content;
            row.appendChild(bubble);
            m.appendChild(row);
        });
        chatPanel.style.display = 'flex';
        m.scrollTop = m.scrollHeight;
        const closeBtn = document.getElementById('chatClose');
        if (closeBtn) {
            closeBtn.onclick = () => {
                chatPanel.style.display = 'none';
                if (chatPollTimer) {
                    clearInterval(chatPollTimer);
                    chatPollTimer = null;
                }
            };
        }
    }

    async function fetchChat(peerId) {
        const res = await fetch('/chat_box/' + peerId);
        if (!res.ok) return null;
        return await res.json();
    }

    async function openChat(peerId) {
        currentPeer = peerId;
        const data = await fetchChat(peerId);
        if (!data) return;
        renderChatMessages(data);
        if (chatPollTimer) {
            clearInterval(chatPollTimer);
        }
        chatPollTimer = setInterval(async () => {
            if (!currentPeer) return;
            const d = await fetchChat(currentPeer);
            if (d) renderChatMessages(d);
        }, 4000);
    }

    document.querySelectorAll('[data-chat]').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.preventDefault();
            openChat(btn.getAttribute('data-chat'));
        });
    });

    document.querySelectorAll('#chatPanel .chat-emoji').forEach(btn => {
        btn.addEventListener('click', function() {
            const input = document.querySelector('#chatForm input[name="content"]');
            if (!input) return;
            input.value = input.value + this.textContent;
            input.focus();
        });
    });

    document.getElementById('chatForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const input = this.querySelector('input[name="content"]');
        const text = input.value.trim();
        if (!text || !currentPeer) return;
        const fd = new FormData();
        fd.append('content', text);
        const res = await fetch('/chat_box/' + currentPeer + '/send', { method: 'POST', body: fd });
        const ok = res.ok ? (await res.json()).ok : false;
        if (ok) {
            const m = document.getElementById('chatMessages');
            const row = document.createElement('div');
            row.style.display = 'flex';
            row.style.justifyContent = 'flex-end';
            const bubble = document.createElement('div');
            bubble.style.maxWidth = '80%';
            bubble.style.padding = '8px 12px';
            bubble.style.margin = '6px 0';
            bubble.style.borderRadius = '12px';
            bubble.style.background = '#e5f0ff';
            bubble.textContent = text;
            row.appendChild(bubble);
            m.appendChild(row);
            m.scrollTop = m.scrollHeight;
            input.value = '';
        }
    });

    function getNotifyContainer() {
        var container = document.querySelector('.notify-container');
        if (!container) {
            container = document.createElement('div');
            container.className = 'notify-container';
            document.body.appendChild(container);
        }
        return container;
    }

    function showNewMessageToast(message, total) {
        if (!message) return;
        var container = getNotifyContainer();
        var item = document.createElement('div');
        item.className = 'notify-item';
        var avatarBox;
        if (message.sender_avatar) {
            avatarBox = document.createElement('img');
            avatarBox.src = message.sender_avatar;
            avatarBox.className = 'notify-avatar';
            avatarBox.alt = 'å¤´åƒ';
        } else {
            avatarBox = document.createElement('div');
            avatarBox.className = 'notify-avatar';
            avatarBox.textContent = 'ğŸ‘¤';
        }
        var textBox = document.createElement('div');
        var title = document.createElement('div');
        title.className = 'notify-title';
        var senderName = message.sender_name || 'ä¼šå‘˜';
        title.textContent = 'æ¥è‡ª ' + senderName + ' çš„æ–°æ¶ˆæ¯';
        var sub = document.createElement('div');
        sub.className = 'small text-white-50';
        var preview = message.content_preview || message.content || '';
        sub.textContent = preview;
        textBox.appendChild(title);
        textBox.appendChild(sub);
        var actions = document.createElement('div');
        actions.className = 'notify-actions';
        var viewBtn = document.createElement('button');
        viewBtn.type = 'button';
        viewBtn.className = 'btn btn-sm btn-outline-light';
        viewBtn.textContent = 'ç«‹å³æŸ¥çœ‹';
        viewBtn.addEventListener('click', function() {
            if (typeof openChat === 'function') {
                openChat(String(message.sender_id));
            } else {
                window.location.href = '/chat/' + message.sender_id;
            }
            container.removeChild(item);
        });
        var closeBtn = document.createElement('button');
        closeBtn.type = 'button';
        closeBtn.className = 'btn btn-sm btn-outline-light';
        closeBtn.textContent = 'å…³é—­';
        closeBtn.addEventListener('click', function() {
            container.removeChild(item);
        });
        actions.appendChild(viewBtn);
        actions.appendChild(closeBtn);
        item.appendChild(avatarBox);
        item.appendChild(textBox);
        item.appendChild(actions);
        container.appendChild(item);
        setTimeout(function() {
            if (item.parentNode === container) {
                container.removeChild(item);
            }
        }, 15000);
    }

    function browserNotificationEnabled() {
        return typeof Notification !== 'undefined' && localStorage.getItem('ga_newmsg_notify_enabled') === '1' && Notification.permission === 'granted';
    }

    function enableBrowserNotifications() {
        if (typeof Notification === 'undefined') {
            alert('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒé€šçŸ¥åŠŸèƒ½');
            return;
        }
        if (Notification.permission === 'granted') {
            localStorage.setItem('ga_newmsg_notify_enabled', '1');
            alert('å·²å¼€å¯æ–°æ¶ˆæ¯æµè§ˆå™¨é€šçŸ¥');
            return;
        }
        if (Notification.permission === 'denied') {
            alert('æ‚¨åœ¨æµè§ˆå™¨ä¸­å…³é—­äº†ç«™ç‚¹é€šçŸ¥ï¼Œè¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­æ‰‹åŠ¨å¼€å¯ã€‚');
            return;
        }
        Notification.requestPermission().then(function(p) {
            if (p === 'granted') {
                localStorage.setItem('ga_newmsg_notify_enabled', '1');
                alert('å·²å¼€å¯æ–°æ¶ˆæ¯æµè§ˆå™¨é€šçŸ¥');
            } else {
                localStorage.removeItem('ga_newmsg_notify_enabled');
            }
        });
    }

    function sendBrowserNotification(message) {
        if (!browserNotificationEnabled() || !message) return;
        var senderName = message.sender_name || 'ä¼šå‘˜';
        var title = 'æ¥è‡ª ' + senderName + ' çš„æ–°æ¶ˆæ¯';
        var body = message.content_preview || message.content || '';
        var options = { body: body };
        if (message.sender_avatar) {
            options.icon = message.sender_avatar;
        }
        try {
            new Notification(title, options);
        } catch (e) {}
    }

    var lastUnreadState = { id: null, total: 0 };

    function initMessageNotifications() {
        if (!window.fetch) return;
        refreshUnreadOnce();
        setInterval(function() {
            refreshUnreadOnce(true);
        }, 9000);
    }

    function refreshUnreadOnce(emitOnChange) {
        fetch('/api/unread_messages', { credentials: 'same-origin' })
            .then(function(res) {
                if (!res.ok) return null;
                return res.json();
            })
            .then(function(data) {
                if (!data) return;
                var total = data.total_unread || 0;
                var msg = data.last_message;
                if (!msg) {
                    lastUnreadState = { id: null, total: total };
                    return;
                }
                if (lastUnreadState.id === null || !emitOnChange) {
                    lastUnreadState = { id: msg.id, total: total };
                    return;
                }
                if (msg.id !== lastUnreadState.id || total > lastUnreadState.total) {
                    lastUnreadState = { id: msg.id, total: total };
                    showNewMessageToast(msg, total);
                    sendBrowserNotification(msg);
                }
            })
            .catch(function() {});
    }

    function startPresence() {
        sendPresencePing();
        setInterval(function() {
            sendPresencePing();
        }, 60000);
        refreshOnlineBadges();
        setInterval(function() {
            refreshOnlineBadges();
        }, 20000);
    }

    function sendPresencePing() {
        if (!window.fetch) return;
        fetch('/api/ping', {
            method: 'POST',
            credentials: 'same-origin'
        }).catch(function() {});
    }

    function refreshOnlineBadges() {
        if (!window.fetch) return;
        fetch('/api/online_users', { credentials: 'same-origin' })
            .then(function(res) {
                if (!res.ok) return null;
                return res.json();
            })
            .then(function(data) {
                if (!data || !data.online_ids) return;
                var set = {};
                data.online_ids.forEach(function(id) {
                    set[String(id)] = true;
                });
                document.querySelectorAll('.member-card').forEach(function(card) {
                    var mid = card.getAttribute('data-member-id');
                    var badge = card.querySelector('[data-online-badge="1"]');
                    if (!badge || !mid) return;
                    if (set[String(mid)]) {
                        badge.textContent = 'åœ¨çº¿';
                        badge.classList.remove('bg-secondary');
                        badge.classList.add('bg-success');
                    } else {
                        badge.textContent = 'ç¦»çº¿';
                        badge.classList.remove('bg-success');
                        badge.classList.add('bg-secondary');
                    }
                });
            })
            .catch(function() {});
    }
</script>
</body>
</html>
