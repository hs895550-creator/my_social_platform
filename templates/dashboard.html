<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GlobalAsianElite - é¦–é¡µ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-purple: #5e3a6e;
        }
        body {
            background-color: #f0f2f5;
        }
        .navbar {
            background-color: var(--primary-purple);
        }
        .navbar-brand, .nav-link {
            color: white !important;
        }
        .modal-header {
            border-bottom: none;
            text-align: center;
            display: block;
        }
        .modal-footer {
            border-top: none;
            justify-content: center;
        }
        .heart-icon {
            font-size: 4rem;
            color: #ccc;
            margin-bottom: 20px;
        }
        .notify-container {
            position: fixed;
            right: 16px;
            bottom: 24px;
            z-index: 1050;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .notify-item {
            background: rgba(0,0,0,0.85);
            color: #fff;
            border-radius: 12px;
            padding: 12px 14px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.25);
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 360px;
        }
        .notify-avatar {
            width: 36px; height: 36px; border-radius: 50%; object-fit: cover; background:#666; display:flex; align-items:center; justify-content:center;
        }
        .notify-title { font-weight: 600; }
        .notify-actions { margin-left: auto; display:flex; gap:8px; }
        .notify-actions form { display:inline; }
    </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg mb-4">
    <div class="container">
        <a class="navbar-brand" href="#">GlobalAsianElite</a>
        <div class="collapse navbar-collapse">
            <ul class="navbar-nav me-auto">
                <li class="nav-item"><a class="nav-link active" href="/dashboard">é¦–é¡µ</a></li>
                <li class="nav-item"><a class="nav-link" href="/messages">è®¯æ¯ <span class="badge bg-danger rounded-pill">6</span></a></li>
                <li class="nav-item"><a class="nav-link" href="/activity">æ´»åŠ¨çºªå½• <span class="badge bg-secondary rounded-pill">{{ activity_counts['likes'] + activity_counts['favorites'] + activity_counts['views'] + activity_counts['blocks'] }}</span></a></li>
            </ul>
            <span class="navbar-text text-white">
                æ¬¢è¿, {{ user.name or 'ä¼šå‘˜' }}
            </span>
            <a href="/logout" class="btn btn-outline-light btn-sm ms-3">é€€å‡º</a>
        </div>
    </div>
</nav>

{% if notifications and notifications|length > 0 %}
<div class="notify-container">
    {% for n in notifications %}
    <div class="notify-item">
        {% if n['actor_avatar'] %}
        <img src="{{ n['actor_avatar'] }}" class="notify-avatar" alt="å¤´åƒ">
        {% else %}
        <div class="notify-avatar">ğŸ‘¤</div>
        {% endif %}
        <div>
            <div class="notify-title">
                {% if n['type'] == 'view' %}
                æœ‰äººæŸ¥çœ‹äº†æ‚¨çš„ä¸ªäººèµ„æ–™ï¼
                {% elif n['type'] == 'like' %}
                ä½ åˆæ”¶åˆ°äº†ä¸€ä¸ªèµï¼
                {% else %}
                æ–°é€šçŸ¥
                {% endif %}
            </div>
            <div class="small text-white-50">
                <a href="/member/{{ n['actor_id'] }}" class="link-light text-decoration-none">
                    æŸ¥çœ‹è°ä¸æ‚¨äº’åŠ¨
                </a>
            </div>
        </div>
        <div class="notify-actions">
            <form action="/notifications/{{ n['id'] }}/read" method="post">
                <button class="btn btn-sm btn-outline-light" type="submit">å…³é—­</button>
            </form>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Right Side Quick Menu -->
<div id="quickMenu" class="position-fixed" style="right:16px; top:14px; z-index:1070;">
    <div class="dropdown">
        <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" style="background-color: var(--primary-purple); color: #fff; border-color: #fff;">
            åŠŸèƒ½
        </button>
        <ul class="dropdown-menu dropdown-menu-end shadow">
            <li><a class="dropdown-item" href="/member/{{ user.id }}">æµè§ˆæ–‡æ¡£</a></li>
            <li><a class="dropdown-item" href="/profile/edit">æ–‡æ¡£ç¼–è¾‘</a></li>
            <li><a class="dropdown-item" href="/profile/photos">ç…§ç‰‡</a></li>
            <li><a class="dropdown-item" href="/dashboard">ä½³ç¼˜</a></li>
            <li><a class="dropdown-item" href="/profile/edit#appearance">å…´è¶£å—œå¥½</a></li>
            <li><a class="dropdown-item" href="/profile/edit#basic">ä¸ªæ€§æ–‡æ¡£</a></li>
            <li><a class="dropdown-item" href="/verification">éªŒè¯æ–‡æ¡£èµ„æ–™</a></li>
            <li><a class="dropdown-item" href="/safety">IMBRA</a></li>
        </ul>
    </div>
</div>

<!-- Ideal Match Modal -->
<div class="modal fade" id="matchModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <div class="heart-icon">â™¥</div>
                <h4 class="modal-title">æè¿°æ‚¨ç†æƒ³çš„å¯¹è±¡æ¥ç»§ç»­</h4>
                <p class="text-muted small">å›ç­”ä¸‹åˆ—æœ‰å…³æ‚¨ç†æƒ³å¯¹è±¡çš„æ¡ä»¶:</p>
            </div>
            <div class="modal-body">
                <form>
                    <div class="mb-3">
                        <label class="form-label">å¯»æ‰¾:</label>
                        <select class="form-select">
                            <option>ç”·æ€§</option>
                            <option>å¥³æ€§</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">å¹´é¾„:</label>
                        <div class="d-flex gap-2">
                            <select class="form-select"><option>18</option><option selected>40</option></select>
                            <span class="align-self-center">è‡³</span>
                            <select class="form-select"><option>50</option><option selected>65</option></select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">å±…ä½åœ°åŒº:</label>
                        <select class="form-select">
                            <option>ä»»ä½•å›½å®¶</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">æ˜¯å¦æŠ½çƒŸ?</label>
                        <div class="d-flex gap-3">
                            <div class="form-check"><input class="form-check-input" type="checkbox" checked><label class="form-check-label">ä¸é™</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox"><label class="form-check-label">ä¸æŠ½çƒŸ</label></div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-purple w-100" data-bs-dismiss="modal" style="background-color: var(--primary-purple); color: white;">ä¿å­˜å¹¶ç»§ç»­</button>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3">
            <div class="card mb-3">
                <div class="card-body text-center">
                    {% if user.avatar_path %}
                    <a href="/member/{{ user.id }}"><img src="{{ user.avatar_path }}" class="rounded-circle mb-3" style="width: 100px; height: 100px; object-fit: cover;"></a>
                    {% else %}
                    <a href="/member/{{ user.id }}" class="d-inline-block">
                        <div class="bg-secondary rounded-circle mb-3 mx-auto d-flex align-items-center justify-content-center" style="width: 100px; height: 100px; color: white; font-size: 2rem; cursor:pointer;">
                            {{ user.name[0] if user.name else 'ç”¨' }}
                        </div>
                    </a>
                    {% endif %}
                    <h5 class="card-title">{{ user.name or 'æœªè®¾ç½®æ˜µç§°' }}</h5>
                    <p class="card-text text-muted">{{ user.city or user.country }}</p>
                    
                    <div class="d-grid gap-2">
                        <a href="/profile/edit" class="btn btn-outline-primary btn-sm">ç¼–è¾‘èµ„æ–™</a>
                        <a href="/profile/photos" class="btn btn-outline-primary btn-sm">ä¸Šä¼ ç…§ç‰‡</a>
                        {% if not user.is_verified %}
                        <a href="/verification" class="btn btn-warning btn-sm">å®åè®¤è¯ (æœªå®Œæˆ)</a>
                        {% else %}
                        <button class="btn btn-success btn-sm" disabled>å·²å®åè®¤è¯ âœ“</button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-md-9">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4>æ¨èä¼šå‘˜</h4>
                <div class="d-flex flex-wrap gap-2">
                    <a class="btn btn-outline-secondary btn-sm {{ 'active' if filter=='' else '' }}" href="/dashboard">ä½³ç¼˜</a>
                    <a class="btn btn-outline-secondary btn-sm {{ 'active' if filter=='mutual' else '' }}" href="/dashboard?filter=mutual">åŒå‘é…å¯¹</a>
                    <a class="btn btn-outline-secondary btn-sm {{ 'active' if filter=='i_liked' else '' }}" href="/dashboard?filter=i_liked">åå‘é…å¯¹ä½³ç¼˜</a>
                    <a class="btn btn-outline-secondary btn-sm {{ 'active' if filter=='online' else '' }}" href="/dashboard?filter=online">åœ¨çº¿</a>
                    <div class="btn-group">
                        <a class="btn btn-outline-secondary btn-sm {{ 'active' if sort=='active' else '' }}" href="/dashboard?sort=active">æŒ‰æ´»è·ƒ</a>
                        <a class="btn btn-outline-secondary btn-sm {{ 'active' if sort=='verified' else '' }}" href="/dashboard?sort=verified">å·²è®¤è¯ä¼˜å…ˆ</a>
                        <a class="btn btn-outline-secondary btn-sm {{ 'active' if sort=='photos' else '' }}" href="/dashboard?sort=photos">æœ‰ç…§ç‰‡ä¼˜å…ˆ</a>
                    </div>
                    <a class="btn btn-outline-secondary btn-sm {{ 'active' if filter=='favorites' else '' }}" href="/dashboard?filter=favorites">æˆ‘çš„æœ€çˆ±</a>
                    <a class="btn btn-outline-secondary btn-sm {{ 'active' if sort=='' else '' }}" href="/dashboard?sort=">æœ€æ–°åŠ å…¥ä¼šå‘˜</a>
                    <a class="btn btn-outline-secondary btn-sm {{ 'active' if sort=='photos' else '' }}" href="/dashboard?sort=photos">æœ€æ–°ç…§ç‰‡</a>
                    <a class="btn btn-outline-secondary btn-sm {{ 'active' if filter=='my_region' else '' }}" href="/dashboard?filter=my_region">æˆ‘çš„åœ°åŒº</a>
                </div>
            </div>

            <div class="row row-cols-1 row-cols-md-3 g-4">
                {% for m in members %}
                <div class="col">
                    <div class="card h-100 shadow-sm">
                        {% if m['avatar_path'] %}
                        <a href="/member/{{ m['id'] }}"><img src="{{ m['avatar_path'] }}" style="height:250px; object-fit:cover;" alt="å¤´åƒ"></a>
                        {% else %}
                        <a href="/member/{{ m['id'] }}" class="text-decoration-none d-block" style="height: 250px;">
                            <div style="height: 100%; background: #eee; display: flex; align-items: center; justify-content: center; color: #aaa; cursor:pointer;">
                                {{ (m['name'] or 'ç”¨æˆ·')[0] if m['name'] else 'ç”¨æˆ·' }}
                            </div>
                        </a>
                        {% endif %}
                        <div class="card-body">
                            <h5 class="card-title">
                                <a href="/member/{{ m['id'] }}" class="text-decoration-none">{{ m['name'] or ('ä¼šå‘˜'+m['id']|string) }}</a>
                                {% if m['is_verified'] %}<span class="badge bg-success ms-2">å·²å®åè®¤è¯</span>{% endif %}
                                <small class="text-muted">{{ m['age_range'] }}</small>
                            </h5>
                            <p class="card-text small text-muted">{{ m['country'] }}</p>
                        </div>
                        <div class="card-footer bg-white border-top-0 d-flex justify-content-between">
                            <form action="/like/{{ m['id'] }}" method="post"><button class="btn btn-light btn-sm" type="submit">â¤</button></form>
                            <button class="btn btn-light btn-sm" data-chat="{{ m['id'] }}">âœ‰</button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var myModal = new bootstrap.Modal(document.getElementById('matchModal'));
    });

    const chatPanel = document.createElement('div');
    chatPanel.id = 'chatPanel';
    chatPanel.style.position = 'fixed';
    chatPanel.style.right = '16px';
    chatPanel.style.top = '80px';
    chatPanel.style.width = '340px';
    chatPanel.style.maxHeight = '70vh';
    chatPanel.style.background = '#2f2140';
    chatPanel.style.color = '#fff';
    chatPanel.style.borderRadius = '12px';
    chatPanel.style.boxShadow = '0 10px 24px rgba(0,0,0,0.3)';
    chatPanel.style.display = 'none';
    chatPanel.style.flexDirection = 'column';
    chatPanel.style.zIndex = '1060';
    chatPanel.innerHTML = '<div id="chatHeader" style="padding:12px;display:flex;justify-content:space-between;align-items:center;"></div><div id="chatMessages" style="padding:12px;overflow:auto;flex:1;background:#fff;color:#000"></div><form id="chatForm" style="padding:12px;border-top:1px solid #ddd;background:#fff"><div class="input-group"><input name="content" class="form-control" placeholder="è¾“å…¥æ¶ˆæ¯..."/><button class="btn btn-primary" type="submit">å‘é€</button></div></form>';
    document.body.appendChild(chatPanel);

    let currentPeer = null;
    const CURRENT_USER_ID = Number('{{ user.id }}');

    async function openChat(peerId) {
        currentPeer = peerId;
        const res = await fetch('/chat_box/' + peerId);
        if (!res.ok) return;
        const data = await res.json();
        const h = document.getElementById('chatHeader');
        const m = document.getElementById('chatMessages');
        h.innerHTML = '<div class="d-flex align-items-center"><div class="rounded-circle me-2" style="width:28px;height:28px;background:#666;display:flex;align-items:center;justify-content:center;color:#fff;">' + ((data.peer.name||'ä¼šå‘˜').slice(0,1)) + '</div><div><strong>' + (data.peer.name||'ä¼šå‘˜') + '</strong> â€¢ ' + (data.peer.country||'') + '</div></div><button type="button" class="btn btn-sm btn-outline-light" id="chatClose">âœ•</button>';
        m.innerHTML = '';
        data.msgs.forEach(x => {
            const mine = x.sender_id === CURRENT_USER_ID;
            const row = document.createElement('div');
            row.style.display = 'flex';
            row.style.justifyContent = mine ? 'flex-end' : 'flex-start';
            const bubble = document.createElement('div');
            bubble.style.maxWidth = '80%';
            bubble.style.padding = '8px 12px';
            bubble.style.margin = '6px 0';
            bubble.style.borderRadius = '12px';
            bubble.style.background = mine ? '#e5f0ff' : '#f3f3f3';
            bubble.textContent = x.content;
            row.appendChild(bubble);
            m.appendChild(row);
        });
        chatPanel.style.display = 'flex';
        m.scrollTop = m.scrollHeight;
        document.getElementById('chatClose').onclick = () => { chatPanel.style.display = 'none'; };
    }

    document.querySelectorAll('[data-chat]').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.preventDefault();
            openChat(btn.getAttribute('data-chat'));
        });
    });

    document.getElementById('chatForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const input = this.querySelector('input[name="content"]');
        const text = input.value.trim();
        if (!text || !currentPeer) return;
        const fd = new FormData();
        fd.append('content', text);
        const res = await fetch('/chat_box/' + currentPeer + '/send', { method: 'POST', body: fd });
        const ok = res.ok ? (await res.json()).ok : false;
        if (ok) {
            const m = document.getElementById('chatMessages');
            const row = document.createElement('div');
            row.style.display = 'flex';
            row.style.justifyContent = 'flex-end';
            const bubble = document.createElement('div');
            bubble.style.maxWidth = '80%';
            bubble.style.padding = '8px 12px';
            bubble.style.margin = '6px 0';
            bubble.style.borderRadius = '12px';
            bubble.style.background = '#e5f0ff';
            bubble.textContent = text;
            row.appendChild(bubble);
            m.appendChild(row);
            m.scrollTop = m.scrollHeight;
            input.value = '';
        }
    });
</script>
</body>
</html>
